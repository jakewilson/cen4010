/*! Meatpocalypse 2016-04-19 */
function pauseFunction(){game.paused=!game.paused,game.paused?tmpPauseTime=game.time.now:pauseTime+=game.time.now-tmpPauseTime}var Entity=function(a,b,c,d,e,f){this._game=a,this._name=b,this._health=c||100,this._sprite=null,this._direction="right",this._WALK_FPS=d||5,this._ATTACK_FPS=e||5,this._WALK_SPEED=250,this._currentPlayingAnim=null,this._attacking=!1,this._bulletPool=null,this._damageRate=f||1500,this._nextDamage=0,this._hurting=!1,this._totalDist=0,this._MAX_PATROL_DIST=160};Entity.prototype.preLoad=function(){this._game.load.atlasJSONHash(this._name,"./assets/spritesheets/"+this._name+".png","./assets/spritesheets/"+this._name+".json")},Entity.prototype.kill=function(){this._sprite.kill()},Entity.prototype.attack=function(){this._currentPlayingAnim=this._sprite.animations.play("attack"+this._direction,this._ATTACK_FPS),this._attacking=!0},Entity.prototype.create=function(a,b,c){c=c||"walkleft1.png",this._sprite=this._game.add.sprite(a,b,this._name,c),this._game.physics.enable(this._sprite),this._sprite.body.collideWorldBounds=!0,this.addAnimation("walkright",["walkright2.png","walkright3.png","walkright4.png"],this._animComplete),this.addAnimation("jumpright",["jumpright1.png"],this._animComplete),this.addAnimation("attackright",["attackright2.png","attackright3.png","attackright4.png"],this._animComplete),this.addAnimation("walkleft",["walkleft2.png","walkleft3.png","walkleft4.png"],this._animComplete),this.addAnimation("jumpleft",["jumpleft1.png"],this._animComplete),this.addAnimation("attackleft",["attackleft2.png","attackleft3.png","attackleft4.png"],this._animComplete)},Entity.prototype.addAnimation=function(a,b,c){this._sprite.animations.add(a,b).onComplete.add(c,this)},Entity.prototype._animComplete=function(){this._sprite.frameName="walk"+this._direction+"1.png",this._currentPlayingAnim=null},Entity.prototype.createBulletPool=function(a){this._bulletPool=new BulletPool(this._game,a,this._sprite)},Entity.prototype.setCollision=function(a,b){this._game.physics.arcade.collide(this._sprite,a,b)},Entity.prototype.update=function(){this._sprite.body.velocity.x=0,this._sprite.y+this._sprite.height>=this._game.height&&this.kill(),this._hurting&&(this._sprite.tint=16711680,this._game.time.now>this._nextDamage&&(this._hurting=!1,this._sprite.tint=16777215))},Entity.prototype.getSprite=function(){return this._sprite},Entity.prototype.setBulletPoolCollision=function(a){this._bulletPool&&this._bulletPool.setCollisionWithEntity(a)},Entity.prototype.setBulletPoolCollisionWithLayer=function(a){this._bulletPool&&this._bulletPool.setCollisionWithLayer(a)},Entity.prototype.hurt=function(){this._game.time.now>this._nextDamage&&(this._nextDamage=this._game.time.now+this._damageRate,this._health-=1,this._hurting=!0,0===this._health&&this.kill())},Entity.prototype.move=function(a){"right"===a?(this._direction="right",this._sprite.body.velocity.x=this._WALK_SPEED):"left"===a&&(this._direction="left",this._sprite.body.velocity.x=-this._WALK_SPEED),(null===this._currentPlayingAnim||this._currentPlayingAnim.name.indexOf("walk")>=0)&&(this._currentPlayingAnim=this._sprite.animations.play("walk"+this._direction,this._WALK_FPS))},Entity.prototype.switchDirection=function(){this._direction="left"===this._direction?"right":"left",this._totalDist=0};var TileSpriteGroup=function(a,b){this._game=a,this._name=b,this._group=null,this._objects=null};TileSpriteGroup.prototype.preLoad=function(){this._game.load.atlasJSONHash(this._name,"./assets/spritesheets/"+this._name+".png","./assets/spritesheets/"+this._name+".json")},TileSpriteGroup.prototype.create=function(a,b,c){b=b||1,c=c||"anim",this._objects=a,this._group=this._game.add.group(),this._group.enableBody=!0,this._group.physicsBodyType=Phaser.Physics.ARCADE;var d=this;this._objects.forEach(function(a,e){var f=d._group.create(a.x,a.y,d._name,b,!0);f.animations.add(c)}),this._group.setAll("body.allowGravity",!1)},TileSpriteGroup.prototype.setCollision=function(a,b){this._game.physics.arcade.overlap(a.getSprite(),this._group,b,null,this)};var Animal=function(a){TileSpriteGroup.call(this,a,"animal"),this._released=!1};Animal.prototype=Object.create(TileSpriteGroup.prototype),Animal.prototype.constructor=Animal,Animal.prototype.setCollision=function(a){var b=function(b,c){c.released||(c.released=!0,c.animations.play("anim",3,!1,!0),a.registerAnimalRescued())};TileSpriteGroup.prototype.setCollision.call(this,a,b)};var Carrot=function(a){TileSpriteGroup.call(this,a,"carrot")};Carrot.prototype=Object.create(TileSpriteGroup.prototype),Carrot.prototype.constructor=Carrot,Carrot.prototype.setCollision=function(a){var b=function(b,c){c.kill(),a.registerCarrotCollected()};TileSpriteGroup.prototype.setCollision.call(this,a,b)};var NUM_BULLETS=10,BULLET_VELOCITY=400,BulletPool=function(a,b){this._game=a,this._pool=this._game.add.group(),this._pool.enableBody=!0,this._pool.physicsBodyType=Phaser.Physics.ARCADE,this._pool.createMultiple(NUM_BULLETS,b),this._pool.setAll("outOfCameraBoundsKill",!0),this._pool.setAll("outOfBoundsKill",!0),this._pool.setAll("autoCull",!0),this._pool.setAll("body.allowGravity",!1),this._nextFire=0,this._FIRE_RATE=350};BulletPool.prototype.fireBullet=function(a,b,c){var d=this._pool.getFirstExists(!1);d&&this._game.time.now>this._nextFire&&(this._nextFire=this._game.time.now+this._FIRE_RATE,d.reset(a,b),"right"===c?d.body.velocity.x=BULLET_VELOCITY:d.body.velocity.x=-1*BULLET_VELOCITY)},BulletPool.prototype.setCollisionWithLayer=function(a){var b=function(a,b){a.kill()};this._game.physics.arcade.collide(a,this._pool,b)},BulletPool.prototype.setCollisionWithEntity=function(a){var b=function(b,c){a.hurt(),c.kill()};this._game.physics.arcade.overlap(a.getSprite(),this._pool,b)},BulletPool.prototype.setFireRate=function(a){this._FIRE_RATE=a};var RangedEnemy=function(a){this._ENEMY_HEALTH=2,Entity.call(this,a,"ranger",this._ENEMY_HEALTH,5,5,500),this._ATTACK_RANGE=224,this._STATES={IDLE:0,PATROL:1,ATTACK:2},this._WALK_SPEED=100,this._state=this._STATES.IDLE,this._direction="left"};RangedEnemy.prototype=Object.create(Entity.prototype),RangedEnemy.prototype.constructor=RangedEnemy,RangedEnemy.prototype.preLoad=function(){Entity.prototype.preLoad.call(this)},RangedEnemy.prototype.create=function(a,b,c){Entity.prototype.create.call(this,a,b,c),this._sprite.body.immovable=!0,this._sprite.body.setSize(33,67,33,10),this.createBulletPool("meat"),this._bulletPool.setFireRate(1e3),this._state=this._STATES.PATROL},RangedEnemy.prototype.setCollisionWithPlayer=function(a){var b=function(b,c){a.hurt()};this._game.physics.arcade.collide(a.getSprite(),this._sprite,b)},RangedEnemy.prototype.update=function(a){if(this._sprite.visible){switch(Entity.prototype.update.call(this),this._state){case this._STATES.PATROL:this._patrol();break;case this._STATES.ATTACK:this.attack()}this._state=this.playerInRange(a)&&this.facingPlayer(a)?this._STATES.ATTACK:this._STATES.PATROL}},RangedEnemy.prototype.attack=function(){Entity.prototype.attack.call(this);var a="left"===this._direction?0:3*(this._sprite.width/4);this._bulletPool.fireBullet(this._sprite.x+a,this._sprite.y+this._sprite.height/4,this._direction)},RangedEnemy.prototype._patrol=function(){Math.abs(this._totalDist)>this._MAX_PATROL_DIST&&Entity.prototype.switchDirection.call(this),this.move(this._direction),this._totalDist+=this._sprite.body.deltaX()},RangedEnemy.prototype.facingPlayer=function(a){var b=this._sprite.body.x-a.getSprite().body.x>0?"left":"right";return b===this._direction},RangedEnemy.prototype.playerInRange=function(a){return this._game.physics.arcade.distanceBetween(a.getSprite(),this._sprite)<=this._ATTACK_RANGE},RangedEnemy.prototype.render=function(){(null!==this._sprite&&this._sprite.body.blocked.left||this._sprite.body.blocked.right)&&Entity.prototype.switchDirection.call(this)};var MeleeEnemy=function(a){this._ENEMY_HEALTH=3,Entity.call(this,a,"butcher",this._ENEMY_HEALTH,5,5,500)};MeleeEnemy.prototype=Object.create(Entity.prototype),MeleeEnemy.prototype.constructor=MeleeEnemy,MeleeEnemy.prototype.create=function(a,b,c){Entity.prototype.create.call(this,a,b,c),this._sprite.body.immovable=!0,this._sprite.body.setSize(29,59,18,28)},MeleeEnemy.prototype.setCollisionWithPlayer=function(a){var b=function(b,c){a.hurt()};this._game.physics.arcade.collide(a.getSprite(),this._sprite,b)};var World=function(a){this._game=a,this._map=null,this.layers=[],this._rangedEnemies=[],this._meleeEnemies=[],this.tofu=new Tofu(a),this.animal=new Animal(a),this.carrot=new Carrot(a),this.trash=new Trash(a),this.enemy=null};World.prototype.preLoad=function(){this._game.load.tilemap("map","./assets/tilemap/map.json",null,Phaser.Tilemap.TILED_JSON),this._game.load.image("background","./assets/tilemap/background.png"),this.tofu.preLoad(),this.carrot.preLoad(),this.animal.preLoad(),this.trash.preLoad(),this._game.load.atlasJSONHash("ranger","./assets/spritesheets/ranger.png","./assets/spritesheets/ranger.json"),this._game.load.image("meat","./assets/spritesheets/meat.png"),this._game.load.atlasJSONHash("butcher","./assets/spritesheets/butcher.png","./assets/spritesheets/butcher.json"),this._game.load.image("tiles","./assets/tiles/tilesheet.png")},World.prototype.create=function(){this._map=game.add.tilemap("map"),this.createLayers(),this.tofu.create(this.layers.Tofu),this.animal.create(this.layers.Animals,3),this.carrot.create(this.layers.Carrots,3),this.trash.create(this.layers.Trash,3),this._map.addTilesetImage("Tilesheet","tiles"),this._map.addTilesetImage("carrotsheet","carrots"),this.setCollisionTiles(),this.layers.First.resizeWorld(),this.createEnemies(),this.enemy=this._rangedEnemies[0]},World.prototype.setCollisionTiles=function(){this._map.setCollisionBetween(18,21),this._map.setCollisionBetween(23,25),this._map.setCollisionBetween(34,35),this._map.setCollisionBetween(39,41),this._map.setCollisionBetween(50,51),this._map.setCollisionBetween(65,69),this._map.setCollision(150)},World.prototype.createLayers=function(){this.layers.First=this._map.createLayer("First"),this.layers.Enemies=this._map.objects.Enemies,this.layers.Tofu=this._map.objects.Tofu,this.layers.Animals=this._map.objects.Animals,this.layers.Carrots=this._map.objects.Carrots,this.layers.Trash=this._map.objects.Trash},World.prototype.update=function(a){this._updateEnemy(this._rangedEnemies,a),this._updateEnemy(this._meleeEnemies,a),this.setCollision(a),a.setBulletPoolCollisionWithLayer(this.layers.First)},World.prototype._updateEnemy=function(a,b){var c=this;a.forEach(function(a){a.update(b,c.layers.First),a.setCollision(c.layers.First),a.setCollisionWithPlayer(b),a.setBulletPoolCollisionWithLayer(c.layers.First),a.setBulletPoolCollision(b),b.setBulletPoolCollision(a)})},World.prototype.setCollision=function(a){this.tofu.setCollision(a),this.carrot.setCollision(a),this.animal.setCollision(a),this.trash.setCollision(a)},World.prototype.createEnemies=function(){this._createRangedEnemies(),this._createMeleeEnemies()},World.prototype._createRangedEnemies=function(){var a=this;this.layers.Enemies.forEach(function(b){if("Range"===b.name){var c=new RangedEnemy(a._game);c.create(b.x,b.y),a._rangedEnemies.push(c)}})},World.prototype._createMeleeEnemies=function(){var a=this;this.layers.Enemies.forEach(function(b){if("Melee"===b.name){var c=new MeleeEnemy(a._game);c.create(b.x,b.y),a._meleeEnemies.push(c)}})},World.prototype.render=function(){this.renderEnemies(this._rangedEnemies)},World.prototype.renderEnemies=function(a){a.forEach(function(a){a.render()})};var Tofu=function(a){TileSpriteGroup.call(this,a,"tofu")};Tofu.prototype=Object.create(TileSpriteGroup.prototype),Tofu.prototype.constructor=Tofu,Tofu.prototype.create=function(a,b){TileSpriteGroup.prototype.create.call(this,a,b,"anim"),this._group.children.forEach(function(a){a.animations.play("anim",5,!0)})},Tofu.prototype.setCollision=function(a){var b=function(b,c){c.kill(),a.heal()};TileSpriteGroup.prototype.setCollision.call(this,a,b)};var Trash=function(a){TileSpriteGroup.call(this,a,"trash")};Trash.prototype=Object.create(TileSpriteGroup.prototype),Trash.prototype.constructor=Trash,Trash.prototype.create=function(a,b){TileSpriteGroup.prototype.create.call(this,a,b,"anim"),this._group.setAll("body.immovable",!0),this._group.children.forEach(function(a){a.animations.play("anim",5,!0),a.body.setSize(20,21,6,43)})},Trash.prototype.setCollision=function(a){var b=function(b,c){a.hurt()};this._game.physics.arcade.collide(a.getSprite(),this._group,b,null,this)};var Player=function(a){this._STARTING_HEALTH=3,this._MAX_HEALTH=6,Entity.call(this,a,"protagonist",this._STARTING_HEALTH,5,5,1500),this._JUMP_FPS=1.5,this._jumping=!1,this._sprinting=!1,this._cursors=null,this._healthPool=null,this._healthY=10,this._healthX=30,this._tofuTextOffset=18,this._score=0,this._scoreTextOffset=425,this._carrotsCollected=0,this._animalsRescued=0,this._carrotMultiplier=10,this._animalMultiplier=1e3,this._enemiesKilled=0,this._enemyMultiplier=100,this._carrotTextOffset=48};Player.prototype=Object.create(Entity.prototype),Player.prototype.constructor=Player;var scoreText,carrotSprite,carrotText;Player.prototype.preLoad=function(){Entity.prototype.preLoad.call(this),this._game.load.image("banana","./assets/spritesheets/banana.png")},Player.prototype.kill=function(){Entity.prototype.kill.call(this),console.log("game over!")},Player.prototype.create=function(a,b){Entity.prototype.create.call(this,a,b,"walkright1.png"),this.createBulletPool("banana"),this._sprite.body.setSize(5,58,30,3),this._game.camera.follow(this._sprite),this._sprintButton=this._game.input.keyboard.addKey(Phaser.Keyboard.D),this._sprintButton.onDown.add(this._sprint,this),this._cursors=this._game.input.keyboard.createCursorKeys(),this._attackButton=this._game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);var c={font:"18px Arial",fill:"#00ff00",align:"left"};scoreText=this._game.add.text(this._scoreTextOffset,18,"Score: ",c),scoreText.fixedToCamera=!0,carrotSprite=this._game.add.sprite(18,48,"carrot"),carrotSprite.fixedToCamera=!0,carrotText=this._game.add.text(this._carrotTextOffset,58,"x "+this._carrotsCollected,c),carrotText.fixedToCamera=!0,this._createHealthPool(),this._drawHealth()},Player.prototype.jump=function(){this._sprite.body.onFloor()&&((!this._currentPlayingAnim||this._currentPlayingAnim.name.indexOf("attack")<0)&&(this._currentPlayingAnim=this._sprite.animations.play("jump"+this._direction,this._JUMP_FPS)),this._sprite.body.velocity.y=-400)},Player.prototype.attack=function(){Entity.prototype.attack.call(this);var a="left"===this._direction?0:3*(this._sprite.width/4);this._bulletPool.fireBullet(this._sprite.x+a,this._sprite.y+this._sprite.height/4,this._direction)},Player.prototype.update=function(){Entity.prototype.update.call(this),this._attackButton.isDown&&this.attack(),this._cursors.right.isDown?this.move("right"):this._cursors.left.isDown&&this.move("left"),this._cursors.up.isDown&&this.jump(),scoreText.text="Score: "+this.getScore(),carrotText.text="x "+this._carrotsCollected},Player.prototype._sprint=function(){this._sprinting?(this._WALK_SPEED=this._WALK_SPEED/5,this._sprinting=!1):(this._WALK_SPEED=5*this._WALK_SPEED,this._sprinting=!0)},Player.prototype._createHealthPool=function(){this._healthPool=this._game.add.group();for(var a=0;a<this._MAX_HEALTH;a++){this._healthPool.create(this._healthX*a+this._tofuTextOffset,this._healthY,"tofu")}this._healthPool.setAll("fixedToCamera",!0)},Player.prototype._drawHealth=function(){this._healthPool.callAll("kill");for(var a=0;a<this._health;a++){var b=this._healthPool.getChildAt(a);b.reset(this._healthX*a,this._healthY)}},Player.prototype.heal=function(){return this._health+=1,this._drawHealth(),this._health},Player.prototype.hurt=function(){Entity.prototype.hurt.call(this),this._drawHealth()},Player.prototype.getCarrotsCollected=function(){return this._carrotsCollected},Player.prototype.getRescuedAnimals=function(){return this._animalsRescued},Player.prototype.registerCarrotCollected=function(){this._carrotsCollected++},Player.prototype.registerAnimalRescued=function(){this._animalsRescued++},Player.prototype.getScore=function(){return this._carrotsCollected*this._carrotMultiplier+this._animalsRescued*this._animalMultiplier+this._enemiesKilled*this._enemyMultiplier};var width=900,height=664,pauseTime=0,tmpPauseTime=0,game=new Phaser.Game(width,height,Phaser.AUTO,"meatpocalypse"),map,layer,player,timerText,loadState={preload:function(){game.load.atlasJSONHash("highScore","../images/mainMenuInverted.png","../images/mainMenuInverted.json"),game.load.atlasJSONHash("quit","../images/mainMenuInverted.png","../images/mainMenuInverted.json"),game.load.atlasJSONHash("play","../images/mainMenuInverted.png","../images/mainMenuInverted.json"),game.load.image("background","../images/MainMenu.png")},create:function(){game.physics.startSystem(Phaser.Physics.ARCADE),game.state.start("play")}},mainMenu={create:function(){function a(){game.state.start("play")}function b(){window.location="/highScore.html"}function c(){window.location="/index.html"}game.add.image(game.world.centerX,game.world.centerY,"background").anchor.set(.5),quit=game.add.button(675,250,"quit",c,this,"RQuit.png","WQuit.png","RQuit.png"),play_button=game.add.button(50,260,"play",a,this,"RPlayButton.png","WPlay.png","RPlayButton.png"),highScore_button=game.add.button(250,495,"highScore",b,this,"WRHS.png","RWHS.png","WRHS.png")}},playState={preload:function(){map=new World(game),map.preLoad(),player=new Player(game),player.preLoad()},create:function(){bg=game.add.tileSprite(0,0,width,height,"background"),bg.fixedToCamera=!0,map.create();var a={font:"18px Arial",fill:"#ffffff",align:"left"};timerText=game.add.text(800,18,"Time: ",a),timerText.fixedToCamera=!0,pauseKey=game.input.keyboard.addKey(Phaser.Keyboard.ESC),pauseKey.onDown.add(pauseFunction,this),player.create(0,480),game.physics.arcade.gravity.y=500},update:function(){player.setCollision(map.layers.First),player.update(),map.update(player),timerText.text="Time: "+((Math.round(game.time.now)-pauseTime)/1e3).toFixed(1)},render:function(){map.render()}};game.state.add("load",loadState,!0),game.state.add("mainMenu",mainMenu),game.state.add("play",playState);